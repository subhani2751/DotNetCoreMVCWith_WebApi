@model DotNetCoreMVCWith_WebApi.Models.Employee
@{
    ViewData["Title"] = "AddEmployee";
}


<form id="AddEmployeeForm">
    <h2>Employee Registration form</h2>
    <div class="form-group">
        <label asp-for="FirstName" class="control-label"></label>
        <input asp-for="FirstName" class="form-control form-control-sm" style="width:40%" />
        @*<span asp-validation-for="FirstName" class="text-danger"></span>*@
    </div>
    <div class="form-group">
        <label asp-for="LastName" class="control-label"></label>
        <input asp-for="LastName" class="form-control form-control-sm" style="width:40%" />
        @*<span asp-validation-for="LastName" class="text-danger"></span>*@
    </div>

    <div class="form-group">
        <label asp-for="Email" class="control-label"></label>
        <input asp-for="Email" type="email" class="form-control form-control-sm" style="width:40%" />
        @*<span asp-validation-for="Email" class="text-danger"></span>*@
    </div>

    <div class="form-group">
        <label asp-for="Department" class="control-label"></label>
        <input asp-for="Department" class="form-control form-control-sm" style="width:40%" />
        @*<span asp-validation-for="Department" class="text-danger"></span>*@
    </div>

    <div class="form-group">
        <label asp-for="HireDate" class="control-label"></label>
        <input asp-for="HireDate" type="date" class="form-control form-control-sm" style="width:40%" />
        @*<span asp-validation-for="HireDate" class="text-danger"></span>*@
    </div>

    <div class="form-group">
        <label asp-for="Salary" class="control-label"></label>
        <input asp-for="Salary" class="form-control form-control-sm" name="Salary" style="width:40%" />
        @*<span asp-validation-for="Salary" class="textdanger"></span>*@
    </div>
    <button type="submit" value="Save" class="btn btn-primary">Save</button>
    <button type="submit" value="Cancel" class="btn btn-secondary">Cancel</button>

</form>
<table class="table table-bordered mt-3">
    <thead id="employeeTableHead" class="table-dark">
        <tr>
            <th>Employee ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th>Department</th>
            <th>Hire Date</th>
            <th>Salary</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="employeeTableBody">
        <!-- Data will be inserted here dynamically -->
    </tbody>
</table>
<script src="~/scripts/validationformates.js"></script>
<script type="text/javascript">
    let actionType = "";
    //$.validator.setDefaults({
    //    ignore: []
    //});
    //console.log("jQuery Loaded:", !!window.jQuery);
    //console.log("Validation Loaded:", typeof $.fn.validate !== "undefined");
    $("button[type=submit]").click(function () {
        actionType = $(this).val(); // Get button value (save or cancel)
        //if(actionType=="Cancel"){
            
        //}
    });
    $(document).ready(function () {
        $("#AddEmployeeForm").validate({
            rules: {
                FirstName: {
                    required: true,
                    AlphabelsFormate: true
                },
                LastName: {
                    required: true,
                    AlphabelsFormate: true
                },
                Email: {
                    required: true,
                    EmailFormate: true
                },
                Department: {
                    required: true,
                    AlphabelsFormate: true
                },
                HireDate: {
                    required: true
                },
                Salary: {
                    required: true,
                    /*number:true,*/
                    minlength: 2,
                    salaryRange: true
                }
            },
            messages: {
                FirstName: {
                    required: "First name is required.",
                    AlphabelsFormate: "Accepts only alphabets.."
                },
                LastName: {
                    required: "last name is required..",
                    AlphabelsFormate: "Accepts only alphabets.."
                },
                Email: {
                    required: "Email is required..",
                    EmailFormate: "Enter a valid Email only"
                },
                Department: {
                    required: "Department is required..",
                    AlphabelsFormate: "Accepts only alphabets.."
                },
                HireDate: {
                    required: "Hire date is required.."
                },
                Salary: {
                    required: "Salary is required",
                    /*number: "only Enter numbers",*/
                    minlength: "At least 2 characters",
                    salaryRange: "Enter a valid salary (numbers and up to 2 decimal places only)"
                }
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element);
                error.css("color", "red");
            },
            submitHandler: function (form) 
              {
                if (actionType === "Save") {
                    var Formdata = {
                        FirstName: $("#FirstName").val(),
                        LastName: $("#LastName").val(),
                        Email: $("#Email").val(),
                        Department: $("#Department").val(),
                        HireDate: $("#HireDate").val(),
                        Salary: $("#Salary").val(),
                    };
                    $.ajax({
                        url: 'https://localhost:44389/api/ApiEmployee',
                        type: 'post',
                        contentType: 'application/json',
                        data: JSON.stringify(Formdata),
                        success: function (response) {
                            form.reset();
                            listEmployees();
                            alert("Employee saved successfully!");
                        },
                        error: function (e) {
                            alert('Error ' + e.responseText);
                        }
                    });
                }
                else if (actionType == "Cancel") {
                    form.reset();
                }
            }
        });
        listEmployees();
       
     });

     function listEmployees(){
        $.ajax({
            url: "https://localhost:44389/api/ApiEmployee/GetAllEmployees",
            type: "get",
            contentType: "application/json",
            success: function (Result) {
                var tableBody = $("#employeeTableBody");
                $.each(Result, function (index, emp) {
                    var row = `<tr id="row_${emp.employeeId}">
                                    <td>${emp.employeeId}</td>
                                    <td>${emp.firstName}</td>
                                    <td>${emp.lastName}</td>
                                    <td>${emp.email}</td>
                                    <td>${emp.department}</td>
                                    <td>${emp.hireDate ? emp.hireDate.split("T")[0] : ""}</td>
                                    <td>${emp.salary}</td>
                                    <td>
                                        <button class="btn btn-success btn-sm Edit" data-id="${emp.employeeId}">Edit</button>
                                        <button class="btn btn-danger btn-sm deleteRow" data-id="${emp.employeeId}">Delete</button>
                                    </td>
                                </tr>`;
                    tableBody.append(row);
                });
                /*alert("data came successfully!" + Result);*/
            },
            error: function (E) {
                alert("data hadn't came !" + E);
            }
        });
     };
          $(document).on("click", ".Edit", function () {
                var Empid = $(this).data("id");
                // var row = $("#row_" + Empid);
                // $.ajax({
                //     url: "https://localhost:44389/Employee/EditEmployee?id=" + Empid,
                //     type: "put",
                //     contentType: "application/json",
                //     success: function(result){
                //         alert("updated success fully");
                //     },
                //     error: function (Er) {
                //         alert("updated success fully");
                //     }
                // });
                window.location.href = "https://localhost:44389/Employee/EditEmployee/" + Empid;
            });
            $(document).on("click", ".deleteRow", function () {
                var Empid = $(this).data("id");
                 var row = $("#row_" + Empid);
                console.log(row);
                $.ajax({
                    url: "https://localhost:44389/api/ApiEmployee/Delete?id=" + Empid,
                    type: "put",
                    contentType: "application/json",
                    data : "",
                    success: function(result){
                        row.remove();
                        alert("Employee Deleted");
                    },
                    error: function (Er) {
                        alert("Employee not Deleted");
                    }
                });
                //window.location.href = "https://localhost:44389/Employee/EditEmployee/" + Empid;
            });
</script>
<style type="text/css">
    .Form-Center {
        display: flex;
        justify-content: space-around;
    }
</style>

